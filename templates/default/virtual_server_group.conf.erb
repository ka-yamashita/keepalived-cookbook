! Configuration File for keepalived
! Generated by Chef.

virtual_server_group <%= @name.upcase %> {
  <% Array(@ip_and_port).each do |value| %>
  <%= value %>
  <% end %>
}

virtual_server group <%= @name.upcase %> {
  delay_loop <%= @delay_loop %>
  lvs_sched  <%= @lvs_sched.to_s %>
  lvs_method <%= @lvs_method.to_s.upcase %>
  protocol   <%= @protocol.to_s.upcase %>
  <% if @sorry_server -%>
  sorry_server <%= @sorry_server %>
  <% end -%>
  <% if @virtual_host -%>
  virtualhost <%= @virtual_host %>
  <% end -%>

  <% @real_servers.each do |server| -%>
  real_server <%= server['ip_address'] %> <%= server['port'] %> {
    weight <%= server['weight'] %>
    <% if server['inhibit_on_failure'] -%>
    inhibit_on_failure
    <% end -%>
    <% if server['notify_up'] -%>
    notify_up <%= server['notify_up'] %>
    <% end -%>
    <% if server['notify_down'] -%>
    notify_down <%= server['notify_down'] %>
    <% end -%>
    <% if server['tcp_check_port'] -%>
    TCP_CHECK {
      connect_port <%= server['tcp_check_port'] %>
      connect_timeout <%= server['tcp_check_timeout'] %>
      <% if server['tcp_check_bind_to'] -%>
      bindto <%= server['tcp_check_bind_to'] %>
      <% end -%>
    }
    <% end -%>
    <% if server['smtp_check_ip'] -%>
    SMTP_CHECK {
      host {
        connect_ip <%= server['smtp_check_ip'] %>
        connect_port <%= server['smtp_check_port'] %>
      }
      connect_timeout <%= server['smtp_check_timeout'] %>
    }
    <% end -%>
    <% if server['misc_check_path'] %>
    MISC_CHECK {
      misc_path <%= server['misc_check_path'] %>
      misc_timeout <%= server['misc_check_timeout'] %>
    }
    <% end -%>
    <% if server['get_type'] -%>
    <%= server['get_type'].to_s.upcase %>_GET {
      url {
        path <%= server['get_path'] %>
        <% if server['get_status_code'] -%>
        status_code <%= server['get_status_code'] %>
        <% end -%>
        <% if server['get_digest'] -%>
        digest <%= server['get_digest'] %>
        <% end -%>
      }
      connect_port <%= server['get_port'] %>
      <% if server['get_bind_to'] -%>
      bindto <%= server['get_bind_to'] %>
      <% end -%>
      connect_timeout <%= server['get_timeout'] %>
      <% if server['get_ng_get_retry'] -%>
      nb_get_retry <%= server['get_ng_retry'] %>
      <% end -%>
      <% if server['get_delay_before_retry'] -%>
      delay_before_retry <%= server['get_delay_before_retry'] %>
      <% end -%>
    }
    <% end -%>
  }
  <% end -%>
}
